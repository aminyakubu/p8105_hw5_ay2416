---
title: "Homework 5"
author: "Amin Yakubu"
date: "11/6/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

### Problem 1 

Unzipping the file and 
```{r}
plyr::ldply(.data = "./data/hw5_data.zip", .fun = unzip)

```

Extracting the filepaths and names into lists
```{r}
filepaths = list.files("./data", pattern = "*.csv", full.names = TRUE)

filenames = basename(filepaths)
```

Writing function to read the data

```{r}
read_fx = function(data, name){
  
  list(read_csv(file = data) %>% mutate(id = name))
  
}

```

Now iterating using `map` function to read all the csv files and bind them together

```{r}
x = purrr::map2(filepaths, filenames, read_fx)

df = purrr::map_df(x, bind_rows)

tidy_data = df %>%
  gather(key = week, value = value, week_1:week_8) %>% 
  mutate(id = str_replace(id, ".csv",""),
         week = as.numeric(str_replace(week, "week_", ""))) %>% 
  separate(id, into = c("group", "id"), sep = "_") %>% 
  mutate(id = as.factor(id))

ggplot(tidy_data, aes(x = week, y = value, color = id, group = id)) + geom_point() + geom_line() + facet_grid(~group) 
```


Problem 2

```{r}
hom_df = read_csv("data/homicide-data.csv", col_names = TRUE) %>% 
  mutate(city_state = str_c(city, ",", " ", state))
```

Describe dataset ---

Summary statistics

Summarize within cities to obtain the total number of homicides and the number of unsolved homicides (those for which the disposition is “Closed without arrest” or “Open/No arrest”).

```{r}
summ_df = hom_df %>% 
  mutate(disposition = fct_collapse(hom_df$disposition, "No arrest" = c("Closed without arrest","Open/No arrest"))) %>% group_by(city_state) %>% 
  count(disposition) %>% 
  spread(key = disposition, value = n) %>% 
  janitor::clean_names() %>% 
  mutate(total = closed_by_arrest + no_arrest)

```

For the city of Baltimore, MD, use the prop.test function to estimate the proportion of homicides that are unsolved; save the output of prop.test as an R object, apply the broom::tidy to this object and pull the estimated proportion and confidence intervals from the resulting tidy dataframe.

```{r}
y = x %>% filter(city_state == "Baltimore, MD")

prop.test(y[[2]], y[[4]]) %>% broom::tidy() %>% .[1:6] %>% 
  select(-statistic, -p.value, -parameter) %>% 
  mutate(city_state = y$city_state) %>% 
  select(city_state, everything())
  
```

Now run prop.test for each of the cities in your dataset, and extract both the proportion of unsolved homicides and the confidence interval for each. Do this within a “tidy” pipeline, making use of purrr::map, purrr::map2, list columns and  unnest as necessary to create a tidy dataframe with estimated proportions and CIs for each city.

Writing a function for `prop.test`

```{r}
prop_test_fx = function(data, state){
  
  y = data %>% filter(city_state == state)
  
  x_out = prop.test(y[[2]], y[[4]]) %>% broom::tidy() %>% .[1:6] %>% 
  select(-statistic, -p.value, -parameter) %>% 
  mutate(city_state = y$city_state) %>% 
  select(city_state, everything())
  
  list(x_out)
  
}
```

Applying the function

```{r}
prop_test_fx(data = summ_df, state = )
```


```{r}
map2(summ_df, summ_df$city_state, prop_test_fx)
```















